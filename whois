using System.Net;
using System.Net.Sockets;
using whois;

Boolean debug = true;

Dictionary<String, User> DataBase = new Dictionary<String, User>
{
     {"cssbct",
      new User {UserID="cssbct",Surname="Tompsett",Forenames="Brian C",Title="Eur Ing",
        Position="Lecturer of Computer Science",
        Phone="+44 1482 46 5222",Email="B.C.Tompsett@hull.ac.uk",Location="in RB-336" }
   }
};

if (args.Length == 0)
{
    Console.WriteLine("Starting Server...");
    RunServer();
}
else
{
    for (int i = 0; i < args.Length; i++)
    {
        ProcessCommand(args[i]);
    }
}


void RunServer()
{
    TcpListener listener;
    Socket connection;
    NetworkStream socketStream;
    try
    {
        listener = new TcpListener(IPAddress.Any, 443);
        listener.Start();
        while (true)
        {
            if (debug) Console.WriteLine("Server Waiting connection...");
            connection = listener.AcceptSocket();
            socketStream = new NetworkStream(connection);
            doRequest(socketStream);
            socketStream.Close();
            connection.Close();
        }
    }
    catch (Exception e)
    {
        Console.WriteLine(e.ToString());
    }
    if (debug)
        Console.WriteLine("Terminating Server");
}

// Handles a network request
void doRequest(NetworkStream socketStream)
{
    StreamWriter sw = new StreamWriter(socketStream);
    StreamReader sr = new StreamReader(socketStream);

    if (debug) Console.WriteLine("Waiting for input from client...");
    string line = sr.ReadLine();

    Console.WriteLine($"Recieved Network Command: {line}");

    //testing 
    //sw.WriteLine(line);
    //sw.Flush();

    if (line == "POST / HTTP/1.1")
    {
        //Then we have an update
        if (debug) Console.WriteLine("Recieved an update request");
        DataBase["cssbct"].Location = "network update test string";
    }
    else if (line.StartsWith("GET /?name=") && line.EndsWith("HTTP/1.1"))
    {
        //then we have a lookup
        if (debug) Console.WriteLine("Received a lookup request");
        string[] slices = line.Split(" "); // split into 3 pieces
        string ID = slices[1].Substring(7);// start at the 7th letter of the middle slice - skip `/?name=`
        if (DataBase.ContainsKey(ID))
        {
            String result = DataBase[ID].Location;
            sw.WriteLine("HTTP/1.1 200 OK");
            sw.WriteLine("Content-Type: text/plain");
            sw.WriteLine();
            sw.WriteLine(result);
            sw.Flush();
            Console.WriteLine($"Performed Lookup on '{ID}' returning '{result},");
        }
        else
        {
            sw.WriteLine("HTTP/1.1 404 Not Found");
            sw.WriteLine("Content-Type: text/plain");
            sw.WriteLine();
            sw.Flush();
            Console.WriteLine($"Performed Lookup on '{ID}' returning '404 Not Found'");
        }
    }
    else
    {
        //then we have an error
        if (debug) Console.WriteLine($"Unrecognised command: '{line}'");
        sw.WriteLine("HTTP/1.1 400 Bad Request");
        sw.WriteLine("Content-Type: text/plain");
        sw.WriteLine();
    }
}

void ProcessCommand(string command)
{
    Console.WriteLine($"\nCommand: {command}");
    String[] slice = command.Split('?', 2);

    String ID = slice[0];
    String? operation = null;
    String? field = null;
    String? update = null;

    if (slice.Length == 2)
    {
        operation = slice[1];
        String[] pieces = operation.Split('=', 2);
        field = pieces[0];
        if (pieces.Length == 2)
        {
            update = pieces[1];
        }
    }

    Console.Write($"Operation on ID '{ID}' ");

    if (operation == null) Dump(ID);
    else if (update == null) Lookup(ID, field);
    else Update(ID, field, update);
}


/// Functions to process database requests
void Dump(String ID)
{
    if (debug) Console.WriteLine("output all fields");

    if (!DataBase.ContainsKey(ID))
    {
        Console.WriteLine($"{ID} does not exist.");
        return;
    }

    Console.WriteLine($"UserID={DataBase[ID].UserID}");
    Console.WriteLine($"Surname={DataBase[ID].Surname}");
    Console.WriteLine($"Forenames={DataBase[ID].Forenames}");
    Console.WriteLine($"Title={DataBase[ID].Title}");
    Console.WriteLine($"Position={DataBase[ID].Position}");
    Console.WriteLine($"Phone={DataBase[ID].Phone}");
    Console.WriteLine($"Email={DataBase[ID].Email}");
    Console.WriteLine($"location={DataBase[ID].Location}");
}
void Lookup(String ID, String field)
{
    if (debug)
        Console.WriteLine($"lookup field '{field}'");

    if (!DataBase.ContainsKey(ID))
    {
        Console.WriteLine($"{ID} does not exist.");
        return;
    }

    String result = null;
    switch (field)
    {
        case "Location": result = DataBase[ID].Location; break;
        case "UserID": result = DataBase[ID].UserID; break;
        case "Surname": result = DataBase[ID].Surname; break;
        case "Forenames": result = DataBase[ID].Forenames; break;
        case "Title": result = DataBase[ID].Title; break;
        case "Phone": result = DataBase[ID].Phone; break;
        case "Position": result = DataBase[ID].Position; break;
        case "Email": result = DataBase[ID].Email; break;
    }
    Console.WriteLine(result);
}
void Update(String ID, String field, String update)
{
    if (debug)
        Console.WriteLine($"update field '{field}' to '{update}'");

    if (!DataBase.ContainsKey(ID))
    {
        DataBase[ID] = new User { UserID = ID };
        Console.WriteLine($"New user '{ID}' was created");
    }
    switch (field)
    {
        case "Location": DataBase[ID].Location = update; break;
        case "UserID": DataBase[ID].UserID = update; break;
        case "Surname": DataBase[ID].Surname = update; break;
        case "Forenames": DataBase[ID].Forenames = update; break;
        case "Title": DataBase[ID].Title = update; break;
        case "Phone": DataBase[ID].Phone = update; break;
        case "Position": DataBase[ID].Position = update; break;
        case "Email": DataBase[ID].Email = update; break;
    }
    Console.WriteLine("OK");
}
